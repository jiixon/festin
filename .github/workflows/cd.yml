# ====================================
# CD (Continuous Deployment) ì›Œí¬í”Œë¡œìš°
# - main ë¸Œëœì¹˜ push ì‹œ ìë™ ë°°í¬
# - Docker Hubì— ì´ë¯¸ì§€ í‘¸ì‹œ
# - EC2ì—ì„œ ìµœì‹  ì´ë¯¸ì§€ë¡œ ì¬ì‹œì‘
# - Docker ë ˆì´ì–´ ìºì‹œ í™œìš©ìœ¼ë¡œ ë¹Œë“œ ì†ë„ ìµœì í™”
# ====================================

name: CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Docker Buildx ì„¤ì •
      # - ë©€í‹° í”Œë«í¼ ë¹Œë“œ ì§€ì›
      # - ìºì‹± ìµœì í™”
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. Docker ë©”íƒ€ë°ì´í„° ìƒì„±
      # - latest: ìµœì‹  ë²„ì „
      # - commit SHA: ë¡¤ë°± ì‹œ ì‚¬ìš©
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/festin
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest

      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # - ë ˆì´ì–´ ìºì‹œ í™œìš© (2-3ë°° ì†ë„ í–¥ìƒ)
      # - Registry ìºì‹œ ì‚¬ìš©
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/festin:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/festin:buildcache,mode=max

      # 6. EC2 ì„œë²„ ë°°í¬
      # - ìµœì‹  ì´ë¯¸ì§€ pull
      # - ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
      # - Health checkë¡œ ë°°í¬ ê²€ì¦
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          FIREBASE_CREDENTIALS_JSON: ${{ secrets.FIREBASE_CREDENTIALS_JSON }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: JWT_SECRET,FIREBASE_CREDENTIALS_JSON
          script: |
            cd ~/festin

            # Docker Hub ë¡œê·¸ì¸
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export DOCKER_IMAGE=${{ secrets.DOCKER_USERNAME }}/festin:latest
            export JWT_SECRET=$JWT_SECRET
            export FIREBASE_CREDENTIALS_JSON=$FIREBASE_CREDENTIALS_JSON

            # ìµœì‹  ì´ë¯¸ì§€ pull
            docker pull $DOCKER_IMAGE

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker stop festin-app || true
            docker rm festin-app || true

            # ìƒˆ ì´ë¯¸ì§€ë¡œ ì¬ì‹œì‘
            docker-compose -f docker-compose.prod.yml up -d app

            # Health check (ìµœì í™”ëœ ê°„ê²©)
            echo "ğŸ” Waiting for application to be healthy..."
            MAX_RETRIES=20
            RETRY_COUNT=0
            SLEEP_INTERVAL=3

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep $SLEEP_INTERVAL

              # Custom health endpoint í™•ì¸
              # TODO: Actuator 500 ì—ëŸ¬ í•´ê²° í›„ /actuator/healthë¡œ ë³€ê²½
              if curl -f -s http://localhost:8080/api/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy!"
                echo "ğŸ“Š Health check passed after $((RETRY_COUNT * SLEEP_INTERVAL)) seconds"
                break
              fi

              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ Retry $RETRY_COUNT/$MAX_RETRIES..."
            done

            # Health check ì‹¤íŒ¨ ì‹œ
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Health check failed after $((MAX_RETRIES * SLEEP_INTERVAL)) seconds"
              echo "ğŸ“‹ Application logs:"
              docker logs festin-app --tail 100
              exit 1
            fi

            # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ (24ì‹œê°„ ì´ìƒëœ ê²ƒë§Œ)
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h"

            echo "ğŸ‰ Deployment completed successfully!"