# ====================================
# CI (Continuous Integration) ì›Œí¬í”Œë¡œìš°
# - PR ë° main push ì‹œ ìë™ ì‹¤í–‰
# - ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
# - Gradle ìºì‹œ í™œìš©ìœ¼ë¡œ ì†ë„ ìµœì í™”
# ====================================

name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # JDK 21 ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Gradle ìºì‹œ ì„¤ì •
      # - ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ì‹œê°„ ì ˆì•½
      # - ë¹Œë“œ ì†ë„ í–¥ìƒ (ìµœëŒ€ 50% ë‹¨ì¶•)
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      # Gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      # - clean ì œê±°: ë¶ˆí•„ìš”í•œ ì‘ì—… ì œê±° (ì‹œê°„ ì ˆì•½)
      # - ë³‘ë ¬ ë¹Œë“œ í™œì„±í™”: --parallel
      # - ë¹Œë“œ ìºì‹œ í™œì„±í™”: --build-cache
      # - ë°ëª¬ ë¹„í™œì„±í™”: CI í™˜ê²½ì—ì„œ ë©”ëª¨ë¦¬ ì ˆì•½
      - name: Build and Test
        run: ./gradlew build --parallel --build-cache --no-daemon --stacktrace
        env:
          SPRING_TESTCONTAINERS_ENABLED: true
          TESTCONTAINERS_RYUK_DISABLED: true

      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œì—ë„ ì‹¤í–‰)
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/
          retention-days: 7

      # í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œì—ë„ ì‹¤í–‰)
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: build/reports/tests/
          retention-days: 7

      # ë¹Œë“œ ì‚°ì¶œë¬¼ ì—…ë¡œë“œ (ì„±ê³µ ì‹œì—ë§Œ)
      # - CD ë‹¨ê³„ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥
      # - ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
      - name: Upload build artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: build/libs/*.jar
          retention-days: 7

      # ë¹Œë“œ ì„±ê³µ ì•Œë¦¼
      - name: Build success summary
        if: success()
        run: |
          echo "âœ… Build and test completed successfully!"
          echo "ğŸ“¦ Artifact uploaded for CD deployment"